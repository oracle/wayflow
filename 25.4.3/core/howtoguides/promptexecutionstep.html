


<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>How to Do Structured LLM Generation in Flows &#8212; wayflowcore 25.4.3 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dba54f56160742ef5599" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dba54f56160742ef5599" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css-style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/core.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=dba54f56160742ef5599"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dba54f56160742ef5599" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dba54f56160742ef5599" />

  
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/tabs.js"></script>
    <script src="../../_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'core/howtoguides/promptexecutionstep';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://oracle.github.io/wayflow/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '25.4.3';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
  <script src="../../_static/announcement.js"></script>

    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How to Add User Confirmation to Tool Call Requests" href="howto_userconfirmation.html" />
    <link rel="prev" title="How to Create Conditional Transitions in Flows" href="conditional_flows.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="25.4" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo-light.svg" class="logo__image only-light" alt="wayflowcore 25.4.3 documentation - Home"/>
    <img src="../../_static/logo-dark.svg" class="logo__image only-dark pst-js-only" alt="wayflowcore 25.4.3 documentation - Home"/>
  
  
</a></div>
    
      <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Essentials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">Tutorials &amp; Use Cases</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/basic_agent.html">Build a Simple Conversational Assistant with Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/basic_flow.html">Build a Simple Fixed-flow Assistant with Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/usecase_prbot.html">Build a Simple Code Review Assistant</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">How-to Guides</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="io_descriptors.html">Change Input and Output Descriptors of Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_async.html">Use Asynchronous APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="agents.html">Create a ReAct Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_imagecontent.html">How to Send Images to LLMs and Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_ociagent.html">Use OCI Generative AI Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_prompttemplate.html">Use Templates for Advanced Prompting Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_userinputinflows.html">Ask for User Input in Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="conditional_flows.html">Create Conditional Transitions in Flows</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Do Structured LLM Generation in Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_userconfirmation.html">Add User Confirmation to a Tool Call Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="catching_exceptions.html">Catch Exceptions in Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_mapstep.html">Do Map and Reduce Operations in Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_agents_in_flows.html">Use Agents in Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_multiagent.html">Build a Hierarchical Multi-Agent System</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_swarm.html">Build a Swarm of Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_managerworkers.html">Build a ManagerWorkers of Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_build_assistants_with_tools.html">Build Assistants with Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_multiple_output_tool.html">Create Tools with Multiple Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="create_a_tool_from_a_flow.html">Convert Flows to Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_mcp.html">Connect MCP tools to Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_remote_tool_expired_token.html">Do Remote API Calls with Tokens</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_execute_agentspec_with_wayflowcore.html">Load and Execute an Agent Spec Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_serdeser.html">Serialize and Deserialize Flows and Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_serialize_conversations.html">Serialize and Deserialize Conversations</a></li>
<li class="toctree-l2"><a class="reference internal" href="generation_config.html">Specify the Generation Configuration when Using LLMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="llm_from_different_providers.html">Use LLM from Different LLM Sources and Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="installing_ollama.html">Install and Use Ollama</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_tracing.html">Enable Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_datastores.html">Connect Assistants to Your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="embeddingmodels_from_different_providers.html">Use Embedding Models from Different Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_evaluation.html">How to Evaluate WayFlow Assistants</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_conversation_evaluation.html">How to Evaluate Assistant Conversations</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto_variable.html">Use Variables for Shared State in Flows</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/index.html">API Reference</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/agentspec.html">Agent Spec Adapters</a></li>

<li class="toctree-l2"><a class="reference internal" href="../api/conversation.html">Conversations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/llmmodels.html">LLMs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/events.html">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/flows.html">Flows</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/agent.html">Agents</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/embeddingmodels.html">Embedding Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/contextproviders.html">Context Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/interrupts.html">Execution Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/prompttemplate.html">PromptTemplates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/serialization.html">Serialization/Deserialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/tools.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/variables.html">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/datastores.html">Datastores</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/warnings.html">Warnings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/evaluation.html">Evaluation</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../misc/reference_sheet.html">Reference Sheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security.html">Security Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">For Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">WayFlow</a></li>
    
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">How to Do Structured LLM Generation in Flows</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="how-to-do-structured-llm-generation-in-flows">
<h1>How to Do Structured LLM Generation in Flows<a class="headerlink" href="#how-to-do-structured-llm-generation-in-flows" title="Permalink to this heading">#</a></h1>
<div class="admonition-prerequisites admonition">
<p class="admonition-title">Prerequisites</p>
<p>This guide assumes familiarity with <a class="reference internal" href="../tutorials/basic_flow.html"><span class="doc">Flows</span></a>.</p>
</div>
<p>WayFlow enables to leverage LLMs to generate text and structured outputs.
This guide will show you how to:</p>
<ul class="simple">
<li><p>use the <a class="reference internal" href="../api/flows.html#promptexecutionstep"><span class="std std-ref">PromptExecutionStep</span></a> to generate text using an LLM</p></li>
<li><p>use the <a class="reference internal" href="../api/flows.html#promptexecutionstep"><span class="std std-ref">PromptExecutionStep</span></a> to generate structured outputs</p></li>
<li><p>use the <a class="reference internal" href="../api/flows.html#agentexecutionstep"><span class="std std-ref">AgentExecutionStep</span></a> to generate structured outputs using an agent</p></li>
</ul>
<section id="basic-implementation">
<h2>Basic implementation<a class="headerlink" href="#basic-implementation" title="Permalink to this heading">#</a></h2>
<p>In this how-to guide, you will learn how to do a structured LLM generation with Flows.</p>
<p>WayFlow supports several LLM API providers.
Select an LLM from the options below:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">OCI GenAI</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">vLLM</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">Ollama</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">OCIGenAIModel</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="n">llm</span> <span class="o">=</span> <span class="n">OCIGenAIModel</span><span class="p">(</span>
        <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;provider.model-id&quot;</span><span class="p">,</span>
        <span class="n">service_endpoint</span><span class="o">=</span><span class="s2">&quot;https://url-to-service-endpoint.com&quot;</span><span class="p">,</span>
        <span class="n">compartment_id</span><span class="o">=</span><span class="s2">&quot;compartment-id&quot;</span><span class="p">,</span>
        <span class="n">auth_type</span><span class="o">=</span><span class="s2">&quot;API_KEY&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">VllmModel</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">VllmModel</span><span class="p">(</span>
    <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;model-id&quot;</span><span class="p">,</span>
    <span class="n">host_port</span><span class="o">=</span><span class="s2">&quot;VLLM_HOST_PORT&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">OllamaModel</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">OllamaModel</span><span class="p">(</span>
    <span class="n">model_id</span><span class="o">=</span><span class="s2">&quot;model-id&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div></div>
<p>Assuming you want to summarize this article:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">article</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Sea turtles are ancient reptiles that have been around for over 100 million years. They play crucial roles in marine ecosystems, such as maintaining healthy seagrass beds and coral reefs. Unfortunately, they are under threat due to poaching, habitat loss, and pollution. Conservation efforts worldwide aim to protect nesting sites and reduce bycatch in fishing gear.&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>WayFlow offers the <a class="reference internal" href="../api/flows.html#promptexecutionstep"><span class="std std-ref">PromptExecutionStep</span></a> for this type of queries.
Use the code below to generate a 10-words summary:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">)])</span>
<span class="n">summarize_step</span> <span class="o">=</span> <span class="n">PromptExecutionStep</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">prompt_template</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Summarize this article in 10 words:</span><span class="se">\n</span><span class="s2"> {{article}}&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">output_mapping</span><span class="o">=</span><span class="p">{</span><span class="n">PromptExecutionStep</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DataFlowEdge</span><span class="p">(</span><span class="n">start_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">summarize_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the prompt, <code class="docutils literal notranslate"><span class="pre">article</span></code> is a Jinja2 syntax to specify a placeholder for a variable, which will appear as an input for the step.
If you use <code class="docutils literal notranslate"><span class="pre">{{var_name}}</span></code>, the variable named <code class="docutils literal notranslate"><span class="pre">var_name</span></code> will be of type <code class="docutils literal notranslate"><span class="pre">StringProperty</span></code>.
If you specify anything else Jinja2 compatible (for loops, filters, and so on), it will be of type <code class="docutils literal notranslate"><span class="pre">AnyProperty</span></code>.</p>
</div>
<p>Now execute the flow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">])</span>
<span class="c1"># Sea turtles face threats from poaching, habitat loss, and pollution globally.</span>
</pre></div>
</div>
<p>As expected, your flow has generated the article summary!</p>
</section>
<section id="structured-generation-with-flows">
<h2>Structured generation with Flows<a class="headerlink" href="#structured-generation-with-flows" title="Permalink to this heading">#</a></h2>
<p>In many cases, generating raw text within a flow is not very useful, as it is difficult to leverage in later steps.
Instead, you might want to generate attributes that follow a particular schema. The <code class="docutils literal notranslate"><span class="pre">PromptExecutionStep</span></code> class enables this through the <cite>output_descriptors</cite> parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.property</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListProperty</span><span class="p">,</span> <span class="n">StringProperty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">animal_output</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;animal_name&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;name of the animal&quot;</span><span class="p">,</span>
    <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">danger_level_output</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;danger_level&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;level of danger of the animal. Can be &quot;HIGH&quot;, &quot;MEDIUM&quot; or &quot;LOW&quot;&#39;</span><span class="p">,</span>
    <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">threats_output</span> <span class="o">=</span> <span class="n">ListProperty</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;threats&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;list of threats for the animal&quot;</span><span class="p">,</span>
    <span class="n">item_type</span><span class="o">=</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;threat&quot;</span><span class="p">),</span>
    <span class="n">default_value</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>


<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">)])</span>
<span class="n">summarize_step</span> <span class="o">=</span> <span class="n">PromptExecutionStep</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">prompt_template</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Extract from the following article the name of the animal, its danger level and the threats it&#39;s subject to. The article:</span><span class="se">\n\n</span><span class="s2"> {{article}}&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">output_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">animal_output</span><span class="p">,</span> <span class="n">danger_level_output</span><span class="p">,</span> <span class="n">threats_output</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DataFlowEdge</span><span class="p">(</span><span class="n">start_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">summarize_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">)</span>
<span class="c1"># {&#39;threats&#39;: [&#39;poaching&#39;, &#39;habitat loss&#39;, &#39;pollution&#39;], &#39;danger_level&#39;: &#39;HIGH&#39;, &#39;animal_name&#39;: &#39;Sea turtles&#39;}</span>
</pre></div>
</div>
</section>
<section id="complex-json-objects">
<h2>Complex JSON objects<a class="headerlink" href="#complex-json-objects" title="Permalink to this heading">#</a></h2>
<p>Sometimes, you might need to generate an object that follows a specific JSON Schema.
You can do that by using an output descriptor of type <code class="docutils literal notranslate"><span class="pre">ObjectProperty</span></code>, or directly converting your JSON Schema into a descriptor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.property</span><span class="w"> </span><span class="kn">import</span> <span class="n">Property</span><span class="p">,</span> <span class="n">StringProperty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">animal_json_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;animal_object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;information about the animal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;animal_name&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;name of the animal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;danger_level&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s1">&#39;level of danger of the animal. Can be &quot;HIGH&quot;, &quot;MEDIUM&quot; or &quot;LOW&quot;&#39;</span><span class="p">,</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;threats&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;list of threats for the animal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
            <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="n">animal_descriptor</span> <span class="o">=</span> <span class="n">Property</span><span class="o">.</span><span class="n">from_json_schema</span><span class="p">(</span><span class="n">animal_json_schema</span><span class="p">)</span>

<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">)])</span>
<span class="n">summarize_step</span> <span class="o">=</span> <span class="n">PromptExecutionStep</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">prompt_template</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Extract from the following article the name of the animal, its danger level and the threats it&#39;s subject to. The article:</span><span class="se">\n\n</span><span class="s2"> {{article}}&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">output_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">animal_descriptor</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DataFlowEdge</span><span class="p">(</span><span class="n">start_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">summarize_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">)</span>
<span class="c1"># {&#39;animal_object&#39;: {&#39;animal_name&#39;: &#39;Sea turtles&#39;, &#39;danger_level&#39;: &#39;MEDIUM&#39;, &#39;threats&#39;: [&#39;Poaching&#39;, &#39;Habitat loss&#39;, &#39;Pollution&#39;]}}</span>
</pre></div>
</div>
</section>
<section id="structured-generation-with-agents">
<h2>Structured generation with Agents<a class="headerlink" href="#structured-generation-with-agents" title="Permalink to this heading">#</a></h2>
<p>In certain scenarios, you might need to invoke additional tools within your flow.
You can instruct the agent to generate specific outputs, and use them in the <code class="docutils literal notranslate"><span class="pre">AgentExecutionStep</span></code> class to perform structured generation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">CallerInputMode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.controlconnection</span><span class="w"> </span><span class="kn">import</span> <span class="n">ControlFlowEdge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[])</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">custom_instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Extract from the article given by the user the name of the animal, its danger level and the threats it&#39;s subject to.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">initial_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">summarize_agent_step</span> <span class="o">=</span> <span class="n">AgentExecutionStep</span><span class="p">(</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span>
    <span class="n">output_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">animal_output</span><span class="p">,</span> <span class="n">danger_level_output</span><span class="p">,</span> <span class="n">threats_output</span><span class="p">],</span>
    <span class="n">caller_input_mode</span><span class="o">=</span><span class="n">CallerInputMode</span><span class="o">.</span><span class="n">NEVER</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_agent_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_agent_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_agent_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>

<span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">()</span>
<span class="n">conversation</span><span class="o">.</span><span class="n">append_user_message</span><span class="p">(</span><span class="s2">&quot;Here is the article: &quot;</span> <span class="o">+</span> <span class="n">article</span><span class="p">)</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">)</span>
<span class="c1"># {&#39;animal_name&#39;: &#39;Sea turtles&#39;, &#39;danger_level&#39;: &#39;HIGH&#39;, &#39;threats&#39;: [&#39;poaching&#39;, &#39;habitat loss&#39;, &#39;pollution&#39;]}</span>
</pre></div>
</div>
</section>
<section id="how-to-write-secure-prompts-with-jinja-templating">
<h2>How to write secure prompts with Jinja templating<a class="headerlink" href="#how-to-write-secure-prompts-with-jinja-templating" title="Permalink to this heading">#</a></h2>
<p id="securejinjatemplating"><a class="reference external" href="https://jinja.palletsprojects.com/en/stable/intro/">Jinja2</a> is a fast and flexible templating engine for Python,
enabling dynamic generation of text-based formats by combining templates with data.</p>
<p>However, enabling all Jinja templating capabilities poses some security challenges.
For this reason, WayFlow relies on a stricter implementation of the Jinjas SandboxedEnvironment for higher security.
Every callable is considered unsafe, and every attribute and item access is prevented, except for:</p>
<ul class="simple">
<li><p>The attributes <code class="docutils literal notranslate"><span class="pre">index0</span></code>, <code class="docutils literal notranslate"><span class="pre">index</span></code>, <code class="docutils literal notranslate"><span class="pre">first</span></code>, <code class="docutils literal notranslate"><span class="pre">last</span></code>, <code class="docutils literal notranslate"><span class="pre">length</span></code> of the <code class="docutils literal notranslate"><span class="pre">jinja2.runtime.LoopContext</span></code>;</p></li>
<li><p>The entries of a python dictionary (only native type is accepted);</p></li>
<li><p>The items of a python list (only native type is accepted).</p></li>
</ul>
<p>You should never write a template that includes a function call, or access to any internal attribute or element of
an arbitrary variable: that is considered unsafe, and it will raise a <code class="docutils literal notranslate"><span class="pre">SecurityException</span></code>.</p>
<p>Moreover, WayFlow performs additional checks on the inputs provided for rendering.
In particular, only elements and sub-elements that are of basic python types
(<code class="docutils literal notranslate"><span class="pre">str</span></code>, <code class="docutils literal notranslate"><span class="pre">int</span></code>, <code class="docutils literal notranslate"><span class="pre">float</span></code>, <code class="docutils literal notranslate"><span class="pre">bool</span></code>, <code class="docutils literal notranslate"><span class="pre">list</span></code>, <code class="docutils literal notranslate"><span class="pre">dict</span></code>, <code class="docutils literal notranslate"><span class="pre">tuple</span></code>, <code class="docutils literal notranslate"><span class="pre">set</span></code>, <code class="docutils literal notranslate"><span class="pre">NoneType</span></code>) are accepted.
In any other case, a <code class="docutils literal notranslate"><span class="pre">SecurityException</span></code> is raised.</p>
<section id="what-you-can-write">
<h3>What you can write<a class="headerlink" href="#what-you-can-write" title="Permalink to this heading">#</a></h3>
<p>Heres a set of common patters that are accepted by WayFlows restricted Jinja templating.</p>
<p>Templates that access variables of base python types:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;simple string&quot;</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var }}&quot;</span>
<span class="c1"># Expected outcome: &quot;simple string&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access elements of a list of base python types:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;simple string&quot;</span><span class="p">]</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var[0] }}&quot;</span>
<span class="c1"># Expected outcome: &quot;simple string&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access dictionary entries of base python types:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k1&quot;</span><span class="p">:</span> <span class="s2">&quot;simple string&quot;</span><span class="p">}</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var[&#39;k1&#39;] }}&quot;</span>
<span class="c1"># Expected outcome: &quot;simple string&quot;</span>

<span class="n">my_var</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k1&quot;</span><span class="p">:</span> <span class="s2">&quot;simple string&quot;</span><span class="p">}</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var.k1 }}&quot;</span>
<span class="c1"># Expected outcome: &quot;simple string&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Builtin functions of Jinja, like <code class="docutils literal notranslate"><span class="pre">length</span></code> or <code class="docutils literal notranslate"><span class="pre">format</span></code>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;simple string&quot;</span><span class="p">]</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var | length }}&quot;</span>
<span class="c1"># Expected outcome: &quot;1&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Simple expressions:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ 7*7 }}&quot;</span>
<span class="c1"># Expected outcome: &quot;49&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">For</span></code> loops, optionally accessing the <code class="docutils literal notranslate"><span class="pre">LoopContext</span></code>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">% f</span><span class="s2">or e in my_var %}{{e}}{{ &#39;, &#39; if not loop.last }}{</span><span class="si">% e</span><span class="s2">ndfor %}&quot;</span>
<span class="c1"># Expected outcome: &quot;1, 2, 3&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">If</span></code> conditions:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{</span><span class="si">% i</span><span class="s2">f my_var % 2 == 0 %}even{</span><span class="si">% e</span><span class="s2">lse %}odd{</span><span class="si">% e</span><span class="s2">ndif %}&quot;</span>
<span class="c1"># Expected outcome: &quot;even&quot;</span>
</pre></div>
</div>
</div></blockquote>
<p>Our general recommendation is to avoid complex logic in templates, and to pre-process the data you want to render instead.
For example, in case of complex objects, in order to comply with restrictions above, you should conveniently
transform them recursively into a dictionary of entries of basic python types (see list of accepted types above).</p>
</section>
<section id="what-you-cannot-write">
<h3>What you cannot write<a class="headerlink" href="#what-you-cannot-write" title="Permalink to this heading">#</a></h3>
<p>Heres a set of common patters that are <strong>NOT</strong> accepted by WayFlows restricted Jinja templating.</p>
<p>Templates that access arbitrary objects:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="n">MyComplexObject</span> <span class="o">=</span> <span class="n">MyComplexObject</span><span class="p">()</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access attributes of arbitrary objects:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="n">MyComplexObject</span> <span class="o">=</span> <span class="n">MyComplexObject</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;my string&quot;</span><span class="p">)</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var.attribute }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access internals of any type and object:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k1&quot;</span><span class="p">:</span> <span class="s2">&quot;my string&quot;</span><span class="p">}</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var.__init__ }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access non-existing keys of a dictionary:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;k1&quot;</span><span class="p">:</span> <span class="s2">&quot;my string&quot;</span><span class="p">}</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var[&#39;non-existing-key&#39;] }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access keys of a dictionary of type different from <code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">str</span></code>:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{(</span><span class="s2">&quot;complex&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">):</span> <span class="s2">&quot;my string&quot;</span><span class="p">}</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var[(&#39;complex&#39;, &#39;key&#39;)] }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>
</pre></div>
</div>
</div></blockquote>
<p>Templates that access callables:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">my_var</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;my value </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var(2) }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>

<span class="n">my_var</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ len(my_var) }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>

<span class="n">my_var</span><span class="p">:</span> <span class="n">MyComplexObject</span> <span class="o">=</span> <span class="n">MyComplexObject</span><span class="p">()</span>
<span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;{{ my_var.to_string() }}&quot;</span>
<span class="c1"># Expected outcome: SecurityException</span>
</pre></div>
</div>
</div></blockquote>
<p>For more information, please check our <a class="reference internal" href="../security.html"><span class="doc">Security considerations page</span></a>.</p>
</section>
</section>
<section id="recap">
<h2>Recap<a class="headerlink" href="#recap" title="Permalink to this heading">#</a></h2>
<p>In this guide, you learned how to incorporate LLMs into flows using the <a class="reference internal" href="../api/flows.html#promptexecutionstep"><span class="std std-ref">PromptExecutionStep</span></a> class to:</p>
<ul class="simple">
<li><p>generate raw text</p></li>
<li><p>produce structured output</p></li>
<li><p>generate structured generation using the agent and <a class="reference internal" href="../api/flows.html#agentexecutionstep"><span class="std std-ref">AgentExecutionStep</span></a></p></li>
</ul>
<details class="summary-below-is-the-complete-code-from-this-guide">
<summary>Below is the complete code from this guide.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">article</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Sea turtles are ancient reptiles that have been around for over 100 million years. They play crucial roles in marine ecosystems, such as maintaining healthy seagrass beds and coral reefs. Unfortunately, they are under threat due to poaching, habitat loss, and pollution. Conservation efforts worldwide aim to protect nesting sites and reduce bycatch in fishing gear.&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span> <span class="o">=</span> <span class="n">LlmModelFactory</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">)])</span>
<span class="n">summarize_step</span> <span class="o">=</span> <span class="n">PromptExecutionStep</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">prompt_template</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Summarize this article in 10 words:</span><span class="se">\n</span><span class="s2"> {{article}}&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">output_mapping</span><span class="o">=</span><span class="p">{</span><span class="n">PromptExecutionStep</span><span class="o">.</span><span class="n">OUTPUT</span><span class="p">:</span> <span class="s2">&quot;summary&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DataFlowEdge</span><span class="p">(</span><span class="n">start_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">summarize_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">])</span>
<span class="c1"># Sea turtles face threats from poaching, habitat loss, and pollution globally.</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.property</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListProperty</span><span class="p">,</span> <span class="n">StringProperty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">PromptExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">animal_output</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;animal_name&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;name of the animal&quot;</span><span class="p">,</span>
    <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">danger_level_output</span> <span class="o">=</span> <span class="n">StringProperty</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;danger_level&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;level of danger of the animal. Can be &quot;HIGH&quot;, &quot;MEDIUM&quot; or &quot;LOW&quot;&#39;</span><span class="p">,</span>
    <span class="n">default_value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">threats_output</span> <span class="o">=</span> <span class="n">ListProperty</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;threats&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;list of threats for the animal&quot;</span><span class="p">,</span>
    <span class="n">item_type</span><span class="o">=</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;threat&quot;</span><span class="p">),</span>
    <span class="n">default_value</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>


<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">StringProperty</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">)])</span>
<span class="n">summarize_step</span> <span class="o">=</span> <span class="n">PromptExecutionStep</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">prompt_template</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Extract from the following article the name of the animal, its danger level and the threats it&#39;s subject to. The article:</span><span class="se">\n\n</span><span class="s2"> {{article}}&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">output_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">animal_output</span><span class="p">,</span> <span class="n">danger_level_output</span><span class="p">,</span> <span class="n">threats_output</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">DataFlowEdge</span><span class="p">(</span><span class="n">start_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">summarize_step</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">})</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">)</span>
<span class="c1"># {&#39;threats&#39;: [&#39;poaching&#39;, &#39;habitat loss&#39;, &#39;pollution&#39;], &#39;danger_level&#39;: &#39;HIGH&#39;, &#39;animal_name&#39;: &#39;Sea turtles&#39;}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.agent</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">CallerInputMode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.controlconnection</span><span class="w"> </span><span class="kn">import</span> <span class="n">ControlFlowEdge</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wayflowcore.steps</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentExecutionStep</span><span class="p">,</span> <span class="n">StartStep</span>

<span class="n">start_step</span> <span class="o">=</span> <span class="n">StartStep</span><span class="p">(</span><span class="n">input_descriptors</span><span class="o">=</span><span class="p">[])</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
    <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
    <span class="n">custom_instruction</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Extract from the article given by the user the name of the animal, its danger level and the threats it&#39;s subject to.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">initial_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">summarize_agent_step</span> <span class="o">=</span> <span class="n">AgentExecutionStep</span><span class="p">(</span>
    <span class="n">agent</span><span class="o">=</span><span class="n">agent</span><span class="p">,</span>
    <span class="n">output_descriptors</span><span class="o">=</span><span class="p">[</span><span class="n">animal_output</span><span class="p">,</span> <span class="n">danger_level_output</span><span class="p">,</span> <span class="n">threats_output</span><span class="p">],</span>
    <span class="n">caller_input_mode</span><span class="o">=</span><span class="n">CallerInputMode</span><span class="o">.</span><span class="n">NEVER</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">summarize_step_name</span> <span class="o">=</span> <span class="s2">&quot;summarize_step&quot;</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">Flow</span><span class="p">(</span>
    <span class="n">begin_step_name</span><span class="o">=</span><span class="s2">&quot;start_step&quot;</span><span class="p">,</span>
    <span class="n">steps</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;start_step&quot;</span><span class="p">:</span> <span class="n">start_step</span><span class="p">,</span>
        <span class="n">summarize_step_name</span><span class="p">:</span> <span class="n">summarize_agent_step</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">control_flow_edges</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">start_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="n">summarize_agent_step</span><span class="p">),</span>
        <span class="n">ControlFlowEdge</span><span class="p">(</span><span class="n">source_step</span><span class="o">=</span><span class="n">summarize_agent_step</span><span class="p">,</span> <span class="n">destination_step</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">data_flow_edges</span><span class="o">=</span><span class="p">[],</span>
<span class="p">)</span>

<span class="n">conversation</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">start_conversation</span><span class="p">()</span>
<span class="n">conversation</span><span class="o">.</span><span class="n">append_user_message</span><span class="p">(</span><span class="s2">&quot;Here is the article: &quot;</span> <span class="o">+</span> <span class="n">article</span><span class="p">)</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">conversation</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">status</span><span class="o">.</span><span class="n">output_values</span><span class="p">)</span>
<span class="c1"># {&#39;animal_name&#39;: &#39;Sea turtles&#39;, &#39;danger_level&#39;: &#39;HIGH&#39;, &#39;threats&#39;: [&#39;poaching&#39;, &#39;habitat loss&#39;, &#39;pollution&#39;]}</span>
</pre></div>
</div>
</details></section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this heading">#</a></h2>
<p>Having learned how to perform structured generation in WayFlow, you may now proceed to:</p>
<ul class="simple">
<li><p><a class="reference internal" href="generation_config.html"><span class="doc">Config Generation</span></a> to change LLM generation parameters.</p></li>
<li><p><a class="reference internal" href="catching_exceptions.html"><span class="doc">Catching Exceptions</span></a> to ensure robustness of the generated outputs.</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-implementation">Basic implementation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#structured-generation-with-flows">Structured generation with Flows</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#complex-json-objects">Complex JSON objects</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#structured-generation-with-agents">Structured generation with Agents</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-to-write-secure-prompts-with-jinja-templating">How to write secure prompts with Jinja templating</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-you-can-write">What you can write</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-you-cannot-write">What you cannot write</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recap">Recap</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=dba54f56160742ef5599"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=dba54f56160742ef5599"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2025, Oracle and/or its affiliates..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>