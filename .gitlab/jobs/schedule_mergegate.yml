schedule_mergegate:
  stage: trigger
  when: manual
  variables:
    DELETE_BRANCH:
      value: "false"
  script:
    - !reference [ .get_merge_request_id, script ]
    - !reference [ .get_private_branch, script ]
    - |
      curl -X POST "${JENKINS_URL}/job/Regression/job/mergegate/buildWithParameters" \
      --user "$JENKINS_BOT_AUTH" \
      --data-urlencode "BRANCH=$PRIVATE_BRANCH" \
      --data-urlencode "PUBLIC_BRANCH=$CI_COMMIT_REF_NAME" \
      --data-urlencode "EMAIL=$GITLAB_USER_EMAIL" \
      --data-urlencode "PUBLIC_PRID=$PUBLIC_MERGE_REQUEST_ID" \
      --data-urlencode "PRIVATE_PRID=$PRIVATE_MERGE_REQUEST_ID" \
      --data-urlencode "COMMIT=$PRIVATE_MERGE_REQUEST_COMMIT_HASH" \
      --data-urlencode "PUBLIC_COMMIT=$CI_COMMIT_SHA" \
      --data-urlencode "PR_SOURCE_PROJECT=$CI_PROJECT_NAMESPACE" \
      --data-urlencode "PR_SOURCE_REPOSITORY=$CI_PROJECT_NAME" \
      --data-urlencode "PR_SOURCE_ID=$PUBLIC_MERGE_REQUEST_ID" \
      --data-urlencode "USE_${REPOSITORY_HOST}=true" \
      --data-urlencode "DELETE_BRANCH=$DELETE_BRANCH" \
      --data-urlencode "${REPOSITORY_HOST}_PIPELINE_ID=$CI_PIPELINE_ID"
    - echo "waiting for external pipeline to appear on gitlab UI"
    - sleep 50
